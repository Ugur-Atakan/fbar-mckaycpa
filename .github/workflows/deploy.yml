name: Deploy Vite Build to Production Branch

on:
  push:
    branches:
      - main  # EÄŸer main branch'e push olduÄŸunda Ã§alÄ±ÅŸmasÄ±nÄ± istiyorsan

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Kodu Checkout Et
        uses: actions/checkout@v3

      - name: Node.js Kurulumu (21 SÃ¼rÃ¼mÃ¼)
        uses: actions/setup-node@v3
        with:
          node-version: 21
          cache: 'npm'

      - name: BaÄŸÄ±mlÄ±lÄ±klarÄ± Kur ve Build Al
        run: |
          npm install
          npm run build

      - name: Production Branchâ€™ini GÃ¼ncelle
        run: |
          git config --global user.name "${{ github.actor }}"  
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

          if [ ! -d "dist" ]; then
            echo "âŒ Build klasÃ¶rÃ¼ bulunamadÄ±! Vite build iÅŸlemi baÅŸarÄ±sÄ±z oldu mu?"
            exit 1
          fi

          # Production branch olup olmadÄ±ÄŸÄ±nÄ± kontrol et
          if git show-ref --verify --quiet refs/heads/production; then
            echo "âœ… Production branch mevcut, gÃ¼ncelleniyor..."
            git checkout production
            git pull origin production  # Branch'i gÃ¼ncelle
          else
            echo "ğŸš€ Production branch bulunamadÄ±, oluÅŸturuluyor..."
            git checkout --orphan production
          fi

          # Ã–nce dist klasÃ¶rÃ¼nÃ¼ geÃ§ici olarak sakla
          mv dist /tmp/dist_backup

          # DiÄŸer dosyalarÄ± temizle ama dist klasÃ¶rÃ¼ silinmemiÅŸ olur
          rm -rf * 

          # dist klasÃ¶rÃ¼nÃ¼ geri taÅŸÄ±
          mv /tmp/dist_backup/* .

          # dist klasÃ¶rÃ¼nÃ¼ temizle (isteÄŸe baÄŸlÄ±)
          rm -rf /tmp/dist_backup

          git add .
          git commit -m "GÃ¼ncellenmiÅŸ Vite Build - $(date)"
          git push -u origin production
