name: Deploy Vite Build to Production Branch

on:
  push:
    branches:
      - main  # EÄŸer main branch'e push olduÄŸunda Ã§alÄ±ÅŸmasÄ±nÄ± istiyorsan

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Kodu Checkout Et
        uses: actions/checkout@v3

      - name: Node.js Kurulumu (21 SÃ¼rÃ¼mÃ¼)
        uses: actions/setup-node@v3
        with:
          node-version: 21
          cache: 'npm'

      - name: BaÄŸÄ±mlÄ±lÄ±klarÄ± Kur ve Build Al
        run: |
          npm install
          npm run build

      - name: Production Branchâ€™ini GÃ¼ncelle
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}  # GitHub Actions Token kullanÄ±yoruz
        run: |
          git config --global user.name "${{ github.actor }}"  
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

          if [ ! -d "dist" ]; then
            echo "âŒ Build klasÃ¶rÃ¼ bulunamadÄ±! Vite build iÅŸlemi baÅŸarÄ±sÄ±z oldu mu?"
            exit 1
          fi

          # Production branch olup olmadÄ±ÄŸÄ±nÄ± kontrol et, varsa pull yap yoksa oluÅŸtur
          if git ls-remote --exit-code origin production; then
            echo "âœ… Production branch mevcut, gÃ¼ncelleniyor..."
            git fetch origin production
            git checkout production
            git pull origin production
          else
            echo "ğŸš€ Production branch bulunamadÄ±, oluÅŸturuluyor..."
            git checkout --orphan production
            git commit --allow-empty -m "Initial empty commit for production"
            git push origin production
          fi
          
          # Ã–nce dist klasÃ¶rÃ¼nÃ¼ geÃ§ici olarak sakla
          mv dist /tmp/dist_backup

          # DiÄŸer dosyalarÄ± temizle ama dist klasÃ¶rÃ¼ silinmemiÅŸ olur
          rm -rf * 

          # dist klasÃ¶rÃ¼nÃ¼ geri taÅŸÄ±
          mv /tmp/dist_backup/* .

          # dist klasÃ¶rÃ¼nÃ¼ temizle (isteÄŸe baÄŸlÄ±)
          rm -rf /tmp/dist_backup

          git add .
          git commit -m "GÃ¼ncellenmiÅŸ Vite Build - $(date)"

          # GitHub Actions Token kullanarak push yap
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git production --force
